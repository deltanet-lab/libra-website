---
id: storage
title: 存储
custom_edit_url: https://github.com/libra/libra/edit/master/storage/README.md
---


The storage module provides reliable and efficient persistent storage for the
entire set of data on the Libra Blockchain, as well as the necessary data used
internally by Libra Core.

存储模块为Libra区块链上的全部数据以及Libra Core内部使用的必要数据提供可靠、高效的持久存储。

## 概览

The storage module is designed to serve two primary purposes:

1. Persist the blockchain data, specifically the transactions and their outputs
   that have been agreed by validators via consensus protocol.
2. Provide a response with Merkle proofs to any query that asks for a part of the
   blockchain data. A client can easily verify the integrity of the response if
   they have obtained the correct root hash.

The Libra Blockchain can be viewed as a Merkle tree consisting of the following
components:

![data](https://developers.libra.org/docs/assets/data.png)

存储模块设计用于两个主要目的：

1. 保存区块链数据，特别是交易及其输出已通过协商一致协议由验证者同意。
2. 对任何要求区块链数据。如果他们得到了正确的根哈希。
Libra区块链可以被视为Merkle树，由以下内容组成组件：

### 账本历史记录

Ledger history is represented by a Merkle accumulator. Each time a transaction
`T` is added to the blockchain, a *TransactionInfo* structure containing the
transaction `T`, the root hash for the state Merkle tree after the execution of
`T` and the root hash for the event Merkle tree generated by `T` is appended to
the accumulator.

### 账本状态

The ledger state at each version is represented by a sparse Merkle tree that has the
state of all accounts. The keys are the 256-bit hash of the addresses, and their
corresponding value is the state of the entire account serialized as a binary
blob. While a tree of size `2^256` is an intractable representation, subtrees
consisting entirely of empty nodes are replaced with a placeholder value, and
subtrees consisting of exactly one leaf are replaced with a single node.

While each *TransactionInfo* structure points to a different state tree, the new
tree can reuse unchanged portion of the previous tree, forming a persistent data
structure.

每个版本的分类账状态都由一个稀疏的merkle树表示，该树具有所有帐户的状态。密钥是地址的256位散列，并且
对应的值是作为二进制文件序列化的整个帐户的状态
布洛布。虽然大小为“2^256”的树是一种难以处理的表示，但子树
完全由空节点组成的将替换为占位符值，并且
只有一片叶子的子树被一个节点所代替。
当每个*transactioninfo*结构指向不同的状态树时，新的
树可以重用前一个树的未更改部分，形成持久数据
结构。

### 事件

Each transaction emits a list of events and those events form a Merkle accumulator.
Similar to the state Merkle tree, the root hash of the event accumulator of a
transaction is recorded in the corresponding *TransactionInfo* structure.

每个事务发出一个事件列表，这些事件形成一个Merkle累加器。
与状态Merkle树类似，一个交易的事件累加器的根哈希记录在相应的*TransactionInfo*结构中。

### Ledger Info and Signatures

A *LedgerInfo* structure that has the root hash of the ledger history
accumulator at some version and other metadata is a binding commitment to
the ledger history up to this version. Validators sign the corresponding
*LedgerInfo* structure every time they agree on a set of transactions and their
execution outcome. For each *LedgerInfo* structure that is stored, a set of
signatures on this structure from validators are also stored, so
clients can verify the structure if they have obtained the public key of each
validator.

## 实现细节

The storage module uses [RocksDB](https://rocksdb.org/) as its physical storage
engine. Since the storage module needs to store multiple types of data, and
key-value pairs in RocksDB are byte arrays, there is a wrapper on top of RocksDB
to deal with the serialization of keys and values. This wrapper enforces that all data in and
out of the DB is structured according to predefined schemas.

The core module that implements the main functionalities is called *LibraDB*.
While we use a single RocksDB instance to store the entire set of data, related
data are grouped into logical stores &mdash; for example, ledger store, state store,
and transaction store, etc.

For the sparse Merkle tree that represents ledger state, we optimize the disk
layout by using branch nodes with 16 children that represents 4-level subtrees
and extension nodes that represents a path without branches. However, we still
simulate a binary tree when computing the root hash and proofs. This modification
results in proofs that are shorter than the ones generated by Ethereum's Merkle
Patricia tree.

## 模块的代码组织
```
    storage
          └── accumulator      # Implementation of Merkle accumulator.
          └── libradb          # Implementation of LibraDB.
          └── schemadb         # Schematized wrapper on top of RocksDB.
          └── scratchpad       # In-memory representation of Libra core data structures used by execution.
          └── jellyfish_merkle # Implementation of sparse Merkle tree.
          └── state_view       # An abstraction layer representing a snapshot of state where the Move VM reads data.
          └── storage_client   # A Rust wrapper on top of GRPC clients.
          └── storage_proto    # All interfaces provided by the storage module.
          └── storage_service  # Storage module as a GRPC service.
```

